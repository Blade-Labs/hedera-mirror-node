apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mirror
spec:
  chart:
    spec:
      chart: ./charts/hedera-mirror
      sourceRef:
        kind: GitRepository
        name: hedera-mirror-node
      valuesFile: values-prod.yaml
      #valuesFile: values-timescaledb.yaml
  dependsOn:
    - name: common
      namespace: common
    - name: sealed-secrets
      namespace: flux-system
  interval: 30s
  rollback:
    force: true
  test:
    enable: true
  timeout: 10m
  upgrade:
    cleanupOnFail: true
    force: true
    remediation:
      retries: 20
  values:
    grpc:
      prometheusRules:
        GrpcNoSubscribers:
          enabled: false
    importer:
      config:
        hedera:
          mirror:
            importer:
              downloader:
                cloudProvider: S3
              initialAddressBook: "/usr/etc/addressbook/addressbook.bin"
              network: OTHER
              startDate: 1970-01-01T00:00:00Z
      extraVolumeMounts:
        - name: addressbook
          mountPath: /usr/etc/addressbook
      extraVolumes:
        - name: addressbook
          secret:
            defaultMode: 420
            secretName: mirror-importer-addressbook
    monitor:
      config:
        hedera:
          mirror:
            monitor:
              network: OTHER
    rest:
      prometheusRules:
        RestNoRequests:
          enabled: false
  valuesFrom:
    - kind: Secret
      name: mirror
